<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CodeSentinel ‚Äî AI Code Security Analyzer</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg: #050810;
  --surface: #0b0f1a;
  --surface2: #111827;
  --border: #1e2a3a;
  --accent: #00f5c4;
  --accent2: #0077ff;
  --danger: #ff3d5a;
  --warn: #ffb347;
  --safe: #00f5c4;
  --text: #e2e8f0;
  --muted: #64748b;
  --mono: 'Space Mono', monospace;
  --sans: 'Syne', sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,245,196,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,196,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
.orb{position:fixed;border-radius:50%;filter:blur(120px);pointer-events:none;z-index:0;opacity:0.15;}
.orb1{width:600px;height:600px;background:var(--accent);top:-200px;right:-200px;}
.orb2{width:500px;height:500px;background:var(--accent2);bottom:-150px;left:-150px;}
.wrap{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:0 24px;}

/* HEADER */
header{padding:28px 0 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);}
.logo{display:flex;align-items:center;gap:12px;}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.logo-text{font-size:22px;font-weight:800;letter-spacing:-0.5px;}
.logo-text span{color:var(--accent);}
.badge{font-family:var(--mono);font-size:11px;color:var(--accent);border:1px solid rgba(0,245,196,0.3);padding:4px 10px;border-radius:20px;background:rgba(0,245,196,0.05);letter-spacing:1px;}

/* HERO */
.hero{padding:60px 0 40px;text-align:center;}
.hero-tag{display:inline-flex;align-items:center;gap:8px;font-family:var(--mono);font-size:11px;color:var(--accent);letter-spacing:2px;text-transform:uppercase;margin-bottom:24px;padding:6px 16px;border:1px solid rgba(0,245,196,0.2);border-radius:20px;background:rgba(0,245,196,0.04);}
.hero-tag::before{content:'';width:6px;height:6px;background:var(--accent);border-radius:50%;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.4;transform:scale(0.8);}}
.hero h1{font-size:clamp(32px,6vw,64px);font-weight:800;line-height:1.05;letter-spacing:-2px;margin-bottom:16px;}
.hero h1 .grad{background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.hero p{font-size:16px;color:var(--muted);max-width:520px;margin:0 auto 32px;line-height:1.7;}

/* STATS */
.stats{display:flex;justify-content:center;gap:40px;margin-bottom:48px;flex-wrap:wrap;}
.stat{text-align:center;}
.stat-num{font-family:var(--mono);font-size:26px;font-weight:700;color:var(--accent);display:block;}
.stat-label{font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}

/* CARD */
.card{background:var(--surface);border:1px solid var(--border);border-radius:20px;overflow:hidden;margin-bottom:24px;position:relative;}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2),transparent);}
.card-header{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.02);flex-wrap:wrap;gap:10px;}
.card-title{font-size:12px;font-family:var(--mono);color:var(--muted);letter-spacing:1px;text-transform:uppercase;display:flex;align-items:center;gap:8px;}
.card-title .dot{width:7px;height:7px;background:var(--accent);border-radius:50%;}

/* LANG SELECTOR */
.lang-row{display:flex;gap:6px;flex-wrap:wrap;}
.lang-btn{font-family:var(--mono);font-size:11px;padding:4px 12px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;}
.lang-btn:hover{border-color:var(--accent);color:var(--accent);}
.lang-btn.active{background:rgba(0,245,196,0.1);border-color:var(--accent);color:var(--accent);}

/* EDITOR */
.editor-wrap{position:relative;}
.line-nums{position:absolute;left:0;top:0;bottom:0;width:44px;padding:20px 0;display:flex;flex-direction:column;align-items:center;border-right:1px solid var(--border);background:rgba(0,0,0,0.2);pointer-events:none;overflow:hidden;}
.line-num{font-family:var(--mono);font-size:11px;color:var(--border);line-height:24px;min-height:24px;width:100%;text-align:center;}
textarea#code{width:100%;min-height:260px;padding:20px 20px 20px 64px;background:transparent;border:none;outline:none;resize:vertical;font-family:var(--mono);font-size:13px;line-height:24px;color:var(--text);caret-color:var(--accent);}
textarea#code::placeholder{color:#2a3a4a;}

/* FOOTER BAR */
.card-footer{padding:14px 24px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.2);flex-wrap:wrap;gap:10px;}
.char-count{font-family:var(--mono);font-size:11px;color:var(--muted);}

/* BUTTON */
.btn-analyze{display:flex;align-items:center;gap:8px;padding:12px 28px;background:linear-gradient(135deg,var(--accent),#00c49a);color:#050810;font-family:var(--sans);font-size:14px;font-weight:700;border:none;border-radius:10px;cursor:pointer;transition:all 0.25s;position:relative;overflow:hidden;}
.btn-analyze:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,245,196,0.3);}
.btn-analyze:active{transform:translateY(0);}
.btn-analyze:disabled{opacity:0.5;cursor:not-allowed;transform:none;}

/* SCANNING */
.scanning{display:none;flex-direction:column;align-items:center;padding:50px 24px;gap:20px;}
.scanning.active{display:flex;}
.scan-ring{width:72px;height:72px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.scan-text{font-family:var(--mono);font-size:12px;color:var(--accent);letter-spacing:2px;text-transform:uppercase;}
.scan-steps{display:flex;flex-direction:column;gap:8px;width:280px;}
.scan-step{display:flex;align-items:center;gap:8px;font-family:var(--mono);font-size:11px;color:var(--muted);opacity:0;transition:opacity 0.5s;}
.scan-step.visible{opacity:1;}
.scan-step .sdot{width:5px;height:5px;background:var(--accent);border-radius:50%;flex-shrink:0;}

/* RESULTS */
#results{display:none;}
#results.active{display:block;}

/* SCORE CARD */
.score-card{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:28px;padding:28px;background:var(--surface);border:1px solid var(--border);border-radius:20px;margin-bottom:20px;position:relative;overflow:hidden;}
.score-card::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at top left,rgba(0,245,196,0.05),transparent 60%);pointer-events:none;}
.score-circle{width:90px;height:90px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;border:3px solid;flex-shrink:0;}
.score-circle.safe{border-color:var(--safe);background:rgba(0,245,196,0.07);}
.score-circle.warn{border-color:var(--warn);background:rgba(255,179,71,0.07);}
.score-circle.danger{border-color:var(--danger);background:rgba(255,61,90,0.07);}
.score-num{font-family:var(--mono);font-size:26px;font-weight:700;line-height:1;}
.score-circle.safe .score-num{color:var(--safe);}
.score-circle.warn .score-num{color:var(--warn);}
.score-circle.danger .score-num{color:var(--danger);}
.score-lbl{font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-top:3px;}
.score-info h3{font-size:20px;font-weight:700;margin-bottom:6px;}
.score-info p{color:var(--muted);font-size:13px;line-height:1.6;}
.vuln-badges{display:flex;flex-direction:column;gap:7px;flex-shrink:0;}
.vuln-badge{display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:11px;padding:5px 12px;border-radius:8px;border:1px solid;white-space:nowrap;}
.vuln-badge.critical{border-color:rgba(255,61,90,0.4);color:var(--danger);background:rgba(255,61,90,0.08);}
.vuln-badge.high{border-color:rgba(255,100,60,0.4);color:#ff643c;background:rgba(255,100,60,0.08);}
.vuln-badge.medium{border-color:rgba(255,179,71,0.4);color:var(--warn);background:rgba(255,179,71,0.08);}
.vuln-badge.low{border-color:rgba(0,245,196,0.4);color:var(--safe);background:rgba(0,245,196,0.08);}
.vuln-badge.info{border-color:rgba(0,119,255,0.4);color:var(--accent2);background:rgba(0,119,255,0.08);}

/* SECTION TITLE */
.section-title{font-size:12px;font-family:var(--mono);color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:14px;display:flex;align-items:center;gap:10px;}
.section-title::after{content:'';flex:1;height:1px;background:var(--border);}

/* ISSUE CARD */
.issue-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;margin-bottom:14px;overflow:hidden;transition:border-color 0.2s;}
.issue-card:hover{border-color:rgba(0,245,196,0.2);}
.issue-header{padding:14px 18px;display:flex;align-items:flex-start;gap:12px;cursor:pointer;user-select:none;}
.sev-pill{font-family:var(--mono);font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;letter-spacing:1px;text-transform:uppercase;flex-shrink:0;margin-top:2px;}
.sev-pill.critical{background:rgba(255,61,90,0.15);color:var(--danger);border:1px solid rgba(255,61,90,0.3);}
.sev-pill.high{background:rgba(255,100,60,0.15);color:#ff643c;border:1px solid rgba(255,100,60,0.3);}
.sev-pill.medium{background:rgba(255,179,71,0.15);color:var(--warn);border:1px solid rgba(255,179,71,0.3);}
.sev-pill.low{background:rgba(0,245,196,0.1);color:var(--safe);border:1px solid rgba(0,245,196,0.25);}
.sev-pill.info{background:rgba(0,119,255,0.1);color:var(--accent2);border:1px solid rgba(0,119,255,0.25);}
.issue-title-wrap{flex:1;}
.issue-title{font-size:14px;font-weight:600;margin-bottom:3px;}
.issue-owasp{font-family:var(--mono);font-size:11px;color:var(--accent2);}
.issue-toggle{font-size:16px;color:var(--muted);transition:transform 0.3s;flex-shrink:0;}
.issue-card.open .issue-toggle{transform:rotate(180deg);}
.issue-body{display:none;padding:0 18px 18px;border-top:1px solid var(--border);}
.issue-card.open .issue-body{display:block;}
.issue-section{margin-top:14px;}
.issue-section-label{font-family:var(--mono);font-size:10px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:7px;}
.issue-desc{font-size:13px;color:#94a3b8;line-height:1.7;}
.code-block{background:#070b14;border:1px solid var(--border);border-radius:8px;padding:12px 14px;font-family:var(--mono);font-size:12px;line-height:1.8;overflow-x:auto;position:relative;}
.code-block.vuln{border-left:3px solid var(--danger);}
.code-block.fix{border-left:3px solid var(--safe);}
.cb-label{position:absolute;top:7px;right:9px;font-size:9px;letter-spacing:1px;text-transform:uppercase;opacity:0.5;}
.code-block.vuln .cb-label{color:var(--danger);}
.code-block.fix .cb-label{color:var(--safe);}
.fix-steps{list-style:none;display:flex;flex-direction:column;gap:7px;}
.fix-steps li{display:flex;align-items:flex-start;gap:8px;font-size:13px;color:#94a3b8;line-height:1.6;}
.fix-steps li::before{content:'‚Üí';color:var(--accent);font-family:var(--mono);flex-shrink:0;}

/* SAFE BANNER */
.safe-banner{display:flex;align-items:center;gap:20px;padding:24px 28px;background:rgba(0,245,196,0.05);border:1px solid rgba(0,245,196,0.2);border-radius:16px;margin-bottom:20px;}
.safe-icon{font-size:36px;}
.safe-banner h3{font-size:18px;font-weight:700;color:var(--safe);margin-bottom:4px;}
.safe-banner p{color:var(--muted);font-size:13px;}

/* SUMMARY */
.summary-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px;margin-bottom:28px;}
.summary-box h4{font-size:12px;font-weight:700;margin-bottom:10px;color:var(--accent);font-family:var(--mono);letter-spacing:1px;text-transform:uppercase;}
.summary-box p{font-size:13px;color:#94a3b8;line-height:1.8;}

/* RESET BTN */
.btn-reset{display:flex;align-items:center;gap:8px;padding:11px 22px;background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:10px;cursor:pointer;font-family:var(--sans);font-size:13px;font-weight:600;transition:all 0.2s;margin-bottom:40px;}
.btn-reset:hover{border-color:var(--accent);color:var(--accent);}

/* ERROR */
.error-box{display:none;align-items:center;gap:14px;padding:16px 22px;background:rgba(255,61,90,0.06);border:1px solid rgba(255,61,90,0.25);border-radius:12px;margin-bottom:20px;font-size:13px;color:#ff8099;}
.error-box.active{display:flex;}

/* FOOTER */
footer{border-top:1px solid var(--border);padding:24px 0;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;}
footer p{font-family:var(--mono);font-size:11px;color:var(--muted);}
footer span{color:var(--accent);}

/* PROGRESS BAR */
.score-bar-wrap{margin-top:10px;}
.score-bar-bg{height:4px;background:var(--border);border-radius:4px;overflow:hidden;}
.score-bar-fill{height:100%;border-radius:4px;transition:width 1s ease;}
.score-bar-fill.safe{background:linear-gradient(90deg,var(--safe),#00c49a);}
.score-bar-fill.warn{background:linear-gradient(90deg,var(--warn),#ff9500);}
.score-bar-fill.danger{background:linear-gradient(90deg,var(--danger),#ff6b6b);}

@media(max-width:680px){
  .score-card{grid-template-columns:1fr;text-align:center;}
  .vuln-badges{flex-direction:row;flex-wrap:wrap;justify-content:center;}
  .hero h1{letter-spacing:-1px;}
  .stats{gap:20px;}
}
</style>
</head>
<body>
<div class="orb orb1"></div>
<div class="orb orb2"></div>
<div class="wrap">

  <!-- HEADER -->
  <header>
    <div class="logo">
      <div class="logo-icon">üõ°Ô∏è</div>
      <div class="logo-text">Code<span>Sentinel</span></div>
    </div>
    <div class="badge">NO API ¬∑ 100% FREE</div>
  </header>

  <!-- HERO -->
  <section class="hero">
    <div class="hero-tag">Static Security Analysis Engine</div>
    <h1>Is Your Code<br/><span class="grad">Actually Safe?</span></h1>
    <p>Paste any code and get an instant security audit ‚Äî zero API keys, zero cost, runs entirely in your browser.</p>
    <div class="stats">
      <div class="stat"><span class="stat-num">50+</span><span class="stat-label">Vulnerability Rules</span></div>
      <div class="stat"><span class="stat-num">OWASP</span><span class="stat-label">Top 10 Mapped</span></div>
      <div class="stat"><span class="stat-num">100%</span><span class="stat-label">Free Forever</span></div>
    </div>
  </section>

  <!-- INPUT -->
  <div id="inputSection">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span class="dot"></span>Code Input</div>
        <div class="lang-row" id="langRow">
          <button class="lang-btn active" onclick="setLang(this,'python')">Python</button>
          <button class="lang-btn" onclick="setLang(this,'javascript')">JavaScript</button>
          <button class="lang-btn" onclick="setLang(this,'php')">PHP</button>
          <button class="lang-btn" onclick="setLang(this,'java')">Java</button>
          <button class="lang-btn" onclick="setLang(this,'sql')">SQL</button>
          <button class="lang-btn" onclick="setLang(this,'general')">Other</button>
        </div>
      </div>
      <div class="editor-wrap">
        <div class="line-nums" id="lineNums"></div>
        <textarea id="code" spellcheck="false"
          placeholder="# Paste your code here to scan for security vulnerabilities..."
          oninput="updateLines();updateCount()"></textarea>
      </div>
      <div class="card-footer">
        <span class="char-count" id="charCount">0 characters ¬∑ 0 lines</span>
        <button class="btn-analyze" id="analyzeBtn" onclick="analyze()">
          <span>‚ö°</span> Scan for Vulnerabilities
        </button>
      </div>
    </div>

    <!-- SCANNING -->
    <div class="card scanning" id="scanning">
      <div class="scan-ring"></div>
      <div class="scan-text">Scanning Code...</div>
      <div class="scan-steps" id="scanSteps">
        <div class="scan-step"><span class="sdot"></span>Parsing code structure</div>
        <div class="scan-step"><span class="sdot"></span>Checking injection patterns</div>
        <div class="scan-step"><span class="sdot"></span>Analyzing authentication logic</div>
        <div class="scan-step"><span class="sdot"></span>Detecting hardcoded secrets</div>
        <div class="scan-step"><span class="sdot"></span>Mapping to OWASP Top 10</div>
      </div>
    </div>
  </div>

  <div class="error-box" id="errorBox">‚ö†Ô∏è <span id="errorMsg"></span></div>

  <!-- RESULTS -->
  <div id="results">
    <div id="scoreCardWrap"></div>
    <div id="issuesWrap"></div>
    <div id="summaryWrap"></div>
    <button class="btn-reset" onclick="reset()">‚Ü© Scan Another Snippet</button>
  </div>

  <footer>
    <p>CodeSentinel ‚Äî Built by <span>Indrajith P K</span> ¬∑ Static Analysis Engine</p>
    <p>Mapped to <span>OWASP Top 10 2021</span> ¬∑ Runs 100% in browser</p>
  </footer>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VULNERABILITY RULES ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RULES = [
  // ‚îÄ‚îÄ INJECTION ‚îÄ‚îÄ
  {
    id:'sqli-format',lang:['python','general'],severity:'critical',
    title:'SQL Injection via String Formatting',
    owasp:'A03:2021 - Injection',
    pattern:/f["'].*SELECT|f["'].*INSERT|f["'].*UPDATE|f["'].*DELETE|f["'].*WHERE.*\{|%s.*SELECT|%s.*WHERE|\.format\(.*\).*sql|\.format\(.*\).*query/i,
    description:'String formatting or f-strings are used to build SQL queries. An attacker can inject malicious SQL by manipulating the input values, potentially accessing, modifying, or deleting database contents.',
    vulnExample:`query = f"SELECT * FROM users WHERE name = '{username}'"`,
    fixExample:`query = "SELECT * FROM users WHERE name = ?"\ncursor.execute(query, (username,))`,
    fixSteps:[
      'Never use f-strings or string concatenation to build SQL queries',
      'Use parameterized queries (prepared statements) with placeholders like ? or %s',
      'Use an ORM like SQLAlchemy which handles escaping automatically',
      'Validate and sanitize all user inputs before processing'
    ]
  },
  {
    id:'sqli-concat',lang:['python','javascript','php','java','general'],severity:'critical',
    title:'SQL Injection via String Concatenation',
    owasp:'A03:2021 - Injection',
    pattern:/["']\s*\+\s*\w+\s*\+\s*["']|"SELECT|"INSERT|"UPDATE|"DELETE|"WHERE.*"\s*\+|query\s*=\s*["'].*\+\s*\w|sql\s*=\s*["'].*\+\s*\w/i,
    description:'SQL queries are being built by directly concatenating user-controlled variables into the query string. This is a textbook SQL injection vulnerability that can lead to full database compromise.',
    vulnExample:`query = "SELECT * FROM users WHERE id = " + user_id`,
    fixExample:`query = "SELECT * FROM users WHERE id = ?"\ncursor.execute(query, (user_id,))`,
    fixSteps:[
      'Replace string concatenation with parameterized queries',
      'Use an ORM (Django ORM, SQLAlchemy, Hibernate) for database interactions',
      'Apply input validation using allowlists for expected data formats',
      'Implement least-privilege database accounts'
    ]
  },
  {
    id:'sqli-php',lang:['php'],severity:'critical',
    title:'SQL Injection in PHP Query',
    owasp:'A03:2021 - Injection',
    pattern:/mysql_query\s*\(|mysqli_query.*\$_(GET|POST|REQUEST)|"SELECT.*\$_(GET|POST|REQUEST)|'SELECT.*\$_(GET|POST|REQUEST)/i,
    description:'PHP code directly uses user input from $_GET, $_POST, or $_REQUEST inside SQL queries without sanitization, making this trivially exploitable.',
    vulnExample:`$query = "SELECT * FROM users WHERE id = " . $_GET['id'];`,
    fixExample:`$stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");\n$stmt->execute([$_GET['id']]);`,
    fixSteps:[
      'Switch to PDO or MySQLi with prepared statements',
      'Never use deprecated mysql_* functions',
      'Use PDO::prepare() and bindParam() for all queries',
      'Enable PDO error handling with exceptions'
    ]
  },

  // ‚îÄ‚îÄ COMMAND INJECTION ‚îÄ‚îÄ
  {
    id:'cmd-injection',lang:['python','php','javascript','general'],severity:'critical',
    title:'Command Injection',
    owasp:'A03:2021 - Injection',
    pattern:/os\.system\s*\(|subprocess\.call\s*\(.*\+|subprocess\.Popen\s*\(.*\+|exec\s*\(.*\$|shell_exec\s*\(.*\$|system\s*\(.*\$|`.*\$\w|eval\s*\(.*input/i,
    description:'User-controlled input is passed directly to a system shell command. An attacker can inject arbitrary OS commands, potentially gaining full server access.',
    vulnExample:`os.system("ping " + user_input)`,
    fixExample:`import subprocess\nresult = subprocess.run(["ping", user_input], capture_output=True)`,
    fixSteps:[
      'Never pass user input directly to shell commands',
      'Use subprocess with a list of arguments (not shell=True)',
      'Validate inputs against a strict allowlist of permitted values',
      'Run processes with least-privilege user accounts'
    ]
  },
  {
    id:'eval-injection',lang:['javascript','python','php','general'],severity:'critical',
    title:'Code Injection via eval()',
    owasp:'A03:2021 - Injection',
    pattern:/eval\s*\(\s*\w*(input|request|query|param|data|user)/i,
    description:'The eval() function is used with user-supplied data, allowing attackers to execute arbitrary code in the application context.',
    vulnExample:`eval(user_input)  # Extremely dangerous`,
    fixExample:`# Remove eval() entirely. Parse JSON with json.loads()\n# or use ast.literal_eval() for safe Python literals`,
    fixSteps:[
      'Never use eval() with any user-controlled data',
      'Use JSON.parse() for JSON data (JavaScript) or json.loads() (Python)',
      'Use ast.literal_eval() for safe evaluation of Python literals only',
      'Redesign logic to eliminate the need for dynamic code execution'
    ]
  },

  // ‚îÄ‚îÄ HARDCODED SECRETS ‚îÄ‚îÄ
  {
    id:'hardcoded-password',lang:['python','javascript','java','php','general'],severity:'high',
    title:'Hardcoded Password or Secret',
    owasp:'A02:2021 - Cryptographic Failures',
    pattern:/password\s*=\s*["'][^"']{3,}["']|passwd\s*=\s*["'][^"']{3,}["']|secret\s*=\s*["'][^"']{3,}["']|api_key\s*=\s*["'][^"']{3,}["']|apikey\s*=\s*["'][^"']{3,}["']|token\s*=\s*["'][^"']{6,}["']/i,
    description:'Credentials or secrets are hardcoded directly in the source code. Anyone with access to the code (including version control history) can extract these secrets.',
    vulnExample:`password = "admin123"\napi_key = "sk-abc123xyz"`,
    fixExample:`import os\npassword = os.environ.get("DB_PASSWORD")\napi_key = os.environ.get("API_KEY")`,
    fixSteps:[
      'Move all secrets to environment variables or a secrets manager (AWS Secrets Manager, HashiCorp Vault)',
      'Use a .env file locally and add it to .gitignore immediately',
      'Rotate any credentials that were already committed to version control',
      'Use tools like git-secrets or truffleHog to scan repositories for leaked secrets'
    ]
  },
  {
    id:'hardcoded-key',lang:['python','javascript','java','php','general'],severity:'high',
    title:'Hardcoded Cryptographic Key',
    owasp:'A02:2021 - Cryptographic Failures',
    pattern:/SECRET_KEY\s*=\s*["'][^"']+["']|private_key\s*=\s*["'][^"']+["']|encryption_key\s*=\s*["'][^"']+["']|AES.*key\s*=\s*["'b]/i,
    description:'A cryptographic key is hardcoded in source code. If this code is ever exposed, all encrypted data protected by this key is compromised.',
    vulnExample:`SECRET_KEY = "my-secret-key-12345"`,
    fixExample:`SECRET_KEY = os.environ.get("SECRET_KEY")`,
    fixSteps:[
      'Store cryptographic keys in environment variables or a key management service',
      'Use a dedicated secrets manager ‚Äî never store keys in source code',
      'Rotate the compromised key immediately if it was committed',
      'Consider using a KMS (AWS KMS, Google Cloud KMS) for key management'
    ]
  },

  // ‚îÄ‚îÄ WEAK CRYPTO ‚îÄ‚îÄ
  {
    id:'md5-hash',lang:['python','javascript','php','java','general'],severity:'high',
    title:'Weak Hashing Algorithm (MD5)',
    owasp:'A02:2021 - Cryptographic Failures',
    pattern:/hashlib\.md5|md5\s*\(|MD5\.digest|\.md5\(/i,
    description:'MD5 is a cryptographically broken hash function. It should never be used for password storage or security-critical operations. MD5 hashes can be cracked in seconds using rainbow tables.',
    vulnExample:`hashed = hashlib.md5(password.encode()).hexdigest()`,
    fixExample:`import bcrypt\nhashed = bcrypt.hashpw(password.encode(), bcrypt.gensalt())`,
    fixSteps:[
      'Replace MD5 with bcrypt, scrypt, or Argon2 for password hashing',
      'Use SHA-256 or SHA-3 for data integrity checks (not passwords)',
      'Never store plaintext or weakly hashed passwords',
      'Re-hash all existing passwords on next user login if migration is needed'
    ]
  },
  {
    id:'sha1-hash',lang:['python','javascript','php','java','general'],severity:'medium',
    title:'Weak Hashing Algorithm (SHA-1)',
    owasp:'A02:2021 - Cryptographic Failures',
    pattern:/hashlib\.sha1|sha1\s*\(|SHA1\.digest|\.sha1\(/i,
    description:'SHA-1 is considered cryptographically weak and vulnerable to collision attacks. It should not be used for security-sensitive purposes.',
    vulnExample:`hashlib.sha1(data.encode()).hexdigest()`,
    fixExample:`hashlib.sha256(data.encode()).hexdigest()`,
    fixSteps:[
      'Replace SHA-1 with SHA-256 or SHA-3 for data integrity',
      'For passwords, use bcrypt, scrypt, or Argon2 exclusively',
      'Update all existing SHA-1 usages in your codebase'
    ]
  },

  // ‚îÄ‚îÄ PATH TRAVERSAL ‚îÄ‚îÄ
  {
    id:'path-traversal',lang:['python','javascript','php','java','general'],severity:'high',
    title:'Path Traversal Vulnerability',
    owasp:'A01:2021 - Broken Access Control',
    pattern:/open\s*\(\s*\w*(path|file|name|input|request)\s*\)|open\s*\(.*\+\s*\w|readFile\s*\(.*\+|include\s*\(\s*\$_(GET|POST)|require\s*\(\s*\$_(GET|POST)/i,
    description:'User-controlled input is used directly in file path operations without sanitization. An attacker can use sequences like "../../../etc/passwd" to read arbitrary files on the server.',
    vulnExample:`with open("/uploads/" + filename, 'r') as f:\n    return f.read()`,
    fixExample:`import os\nsafe_dir = "/var/www/uploads"\nfull_path = os.path.realpath(os.path.join(safe_dir, filename))\nif not full_path.startswith(safe_dir):\n    raise ValueError("Invalid path")\nwith open(full_path, 'r') as f:\n    return f.read()`,
    fixSteps:[
      'Use os.path.realpath() to resolve the full canonical path',
      'Verify the resolved path starts with your intended base directory',
      'Allowlist permitted filenames or extensions rather than blocking bad patterns',
      'Store user files outside the web root with randomized names'
    ]
  },

  // ‚îÄ‚îÄ XSS ‚îÄ‚îÄ
  {
    id:'xss-innerhtml',lang:['javascript'],severity:'high',
    title:'Cross-Site Scripting (XSS) via innerHTML',
    owasp:'A03:2021 - Injection',
    pattern:/innerHTML\s*=\s*\w|innerHTML\s*\+=|\.innerHTML\s*=\s*[^"'`]/i,
    description:'Setting innerHTML with user-controlled data allows attackers to inject malicious HTML and JavaScript, potentially hijacking user sessions or stealing credentials.',
    vulnExample:`document.getElementById("output").innerHTML = userInput;`,
    fixExample:`document.getElementById("output").textContent = userInput;\n// OR use DOMPurify for HTML content:\nelement.innerHTML = DOMPurify.sanitize(userInput);`,
    fixSteps:[
      'Use textContent instead of innerHTML for plain text output',
      'Use DOMPurify library to sanitize HTML before inserting it into the DOM',
      'Implement a strict Content Security Policy (CSP) header',
      'Encode all output using context-appropriate encoding'
    ]
  },
  {
    id:'xss-document-write',lang:['javascript'],severity:'high',
    title:'Cross-Site Scripting via document.write()',
    owasp:'A03:2021 - Injection',
    pattern:/document\.write\s*\(\s*\w|document\.writeln\s*\(\s*\w/i,
    description:'document.write() with user input creates XSS vulnerabilities and is considered a dangerous and deprecated practice.',
    vulnExample:`document.write(location.search.substring(1));`,
    fixExample:`// Use DOM manipulation instead:\ndocument.getElementById("output").textContent = sanitizedInput;`,
    fixSteps:[
      'Remove all uses of document.write() from your codebase',
      'Use safe DOM APIs like createElement, textContent, or appendChild',
      'Sanitize any HTML content with DOMPurify before rendering'
    ]
  },

  // ‚îÄ‚îÄ INSECURE DESERIALIZATION ‚îÄ‚îÄ
  {
    id:'pickle-deserialize',lang:['python'],severity:'critical',
    title:'Insecure Deserialization (pickle)',
    owasp:'A08:2021 - Software and Data Integrity Failures',
    pattern:/pickle\.loads?\s*\(|pickle\.Unpickler|cPickle\.loads?/i,
    description:'pickle.loads() on untrusted data can execute arbitrary Python code during deserialization. This is one of the most dangerous vulnerabilities in Python applications.',
    vulnExample:`import pickle\ndata = pickle.loads(user_supplied_bytes)`,
    fixExample:`import json\ndata = json.loads(user_supplied_string)  # Safe alternative`,
    fixSteps:[
      'Never deserialize pickle data from untrusted sources',
      'Use JSON or MessagePack for data serialization instead',
      'If pickle is required, cryptographically sign the data before transmission and verify before loading',
      'Consider using safer serialization libraries like marshmallow'
    ]
  },

  // ‚îÄ‚îÄ AUTHENTICATION ‚îÄ‚îÄ
  {
    id:'broken-auth-admin',lang:['python','javascript','php','java','general'],severity:'high',
    title:'Hardcoded Admin Credentials',
    owasp:'A07:2021 - Identification and Authentication Failures',
    pattern:/if\s+\w+\s*==\s*["']admin["']|if\s+password\s*==\s*["']|username\s*==\s*["']admin["']\s*and|if\s+\w+\s*==\s*["']password["']/i,
    description:'Authentication is performed by comparing against hardcoded credential strings. These credentials are exposed in source code and provide a trivial bypass for attackers.',
    vulnExample:`if username == "admin" and password == "admin123":`,
    fixExample:`# Use a proper authentication library\nfrom werkzeug.security import check_password_hash\nif check_password_hash(stored_hash, password):`,
    fixSteps:[
      'Store password hashes (never plaintext) in a database',
      'Use bcrypt, Argon2, or scrypt for password hashing',
      'Implement proper session management with secure tokens',
      'Use a battle-tested authentication library for your framework'
    ]
  },

  // ‚îÄ‚îÄ SENSITIVE DATA EXPOSURE ‚îÄ‚îÄ
  {
    id:'debug-mode',lang:['python','javascript','php','general'],severity:'medium',
    title:'Debug Mode Enabled in Production',
    owasp:'A05:2021 - Security Misconfiguration',
    pattern:/DEBUG\s*=\s*True|debug\s*=\s*true|app\.run\s*\(.*debug\s*=\s*True|display_errors\s*=\s*On/i,
    description:'Debug mode is enabled, which can expose stack traces, internal variables, and sensitive configuration details to anyone who triggers an error.',
    vulnExample:`app.run(debug=True)  # Never in production`,
    fixExample:`app.run(debug=os.environ.get("FLASK_DEBUG", "False") == "True")`,
    fixSteps:[
      'Set debug=False in all production environments',
      'Use environment variables to control debug settings',
      'Implement proper error logging to a secure log file instead',
      'Return generic error messages to users in production'
    ]
  },
  {
    id:'sensitive-log',lang:['python','javascript','java','general'],severity:'medium',
    title:'Sensitive Data in Logs',
    owasp:'A09:2021 - Security Logging and Monitoring Failures',
    pattern:/print\s*\(.*password|log\s*\(.*password|console\.log\s*\(.*password|logger\.\w+\s*\(.*password|print\s*\(.*token|log.*secret/i,
    description:'Passwords, tokens, or other sensitive data are being printed or logged. Log files are often accessible to multiple people and systems.',
    vulnExample:`print(f"User login: {username}, password: {password}")`,
    fixExample:`print(f"User login attempt: {username}")  # Log only non-sensitive data`,
    fixSteps:[
      'Never log passwords, tokens, API keys, or PII',
      'Mask or redact sensitive fields before logging',
      'Review all logging statements to ensure no credentials are captured',
      'Use structured logging with explicit field control'
    ]
  },

  // ‚îÄ‚îÄ INSECURE RANDOM ‚îÄ‚îÄ
  {
    id:'weak-random',lang:['python','javascript','general'],severity:'medium',
    title:'Insecure Random Number Generation',
    owasp:'A02:2021 - Cryptographic Failures',
    pattern:/import random|Math\.random\s*\(\s*\)|random\.randint|random\.choice|random\.random\s*\(\)/i,
    description:'Standard random number generators are not cryptographically secure and should not be used for security tokens, session IDs, passwords, or any security-sensitive purpose.',
    vulnExample:`token = random.randint(100000, 999999)`,
    fixExample:`import secrets\ntoken = secrets.token_hex(32)  # Cryptographically secure`,
    fixSteps:[
      'Use the secrets module (Python) for all security tokens and IDs',
      'Use crypto.getRandomValues() in JavaScript instead of Math.random()',
      'Use os.urandom() for raw random bytes when needed',
      'Never use random.random() or Math.random() for anything security-related'
    ]
  },

  // ‚îÄ‚îÄ XXXX ‚îÄ‚îÄ
  {
    id:'xxe',lang:['python','java','php','general'],severity:'high',
    title:'XML External Entity (XXE) Injection',
    owasp:'A05:2021 - Security Misconfiguration',
    pattern:/xml\.etree|minidom\.parse|lxml\.etree|XMLParser|parseString.*xml|DOMParser|SAXParser/i,
    description:'XML parsing without disabling external entities can allow attackers to read arbitrary files, perform server-side request forgery (SSRF), or cause denial of service.',
    vulnExample:`import xml.etree.ElementTree as ET\ntree = ET.parse(user_xml_file)`,
    fixExample:`from defusedxml import ElementTree as ET\ntree = ET.parse(user_xml_file)  # Safe`,
    fixSteps:[
      'Use defusedxml library instead of standard xml library in Python',
      'Disable external entity processing in your XML parser configuration',
      'Validate and sanitize XML input before parsing',
      'Consider using JSON instead of XML for data exchange where possible'
    ]
  },

  // ‚îÄ‚îÄ OPEN REDIRECT ‚îÄ‚îÄ
  {
    id:'open-redirect',lang:['python','javascript','php','general'],severity:'medium',
    title:'Open Redirect Vulnerability',
    owasp:'A01:2021 - Broken Access Control',
    pattern:/redirect\s*\(\s*request\.|redirect\s*\(\s*\$_(GET|POST)|window\.location\s*=\s*\w*(param|query|input|url)/i,
    description:'The application redirects users to a URL controlled by user input without validation. This can be used for phishing attacks or to bypass authentication.',
    vulnExample:`return redirect(request.args.get('next'))`,
    fixExample:`from urllib.parse import urlparse\nnext_url = request.args.get('next', '/')\nif not urlparse(next_url).netloc:  # Only allow relative URLs\n    return redirect(next_url)`,
    fixSteps:[
      'Validate redirect URLs against a strict allowlist of trusted domains',
      'Only allow relative URLs for internal redirects',
      'Reject or sanitize any redirect URL containing external domains',
      'Implement CSRF protection alongside redirect validation'
    ]
  },

  // ‚îÄ‚îÄ SSRF ‚îÄ‚îÄ
  {
    id:'ssrf',lang:['python','javascript','php','general'],severity:'high',
    title:'Server-Side Request Forgery (SSRF)',
    owasp:'A10:2021 - Server-Side Request Forgery',
    pattern:/requests\.get\s*\(\s*\w*(url|input|param|request)|urllib.*open\s*\(\s*\w*(url|input)|fetch\s*\(\s*\w*(url|input|param)|file_get_contents\s*\(\s*\$_(GET|POST)/i,
    description:'User-controlled input is used as a URL for server-side HTTP requests. Attackers can use this to access internal services, cloud metadata endpoints, or scan the internal network.',
    vulnExample:`response = requests.get(user_provided_url)`,
    fixExample:`from urllib.parse import urlparse\nallowed_hosts = ["api.trusted.com"]\nparsed = urlparse(user_url)\nif parsed.hostname in allowed_hosts:\n    response = requests.get(user_url)`,
    fixSteps:[
      'Validate URLs against an allowlist of permitted hosts and schemes',
      'Block requests to internal IP ranges (127.x, 10.x, 172.16-31.x, 192.168.x)',
      'Use a firewall to restrict outbound connections from your server',
      'Disable unnecessary URL schemes (file://, gopher://, dict://)'
    ]
  },

  // ‚îÄ‚îÄ INSECURE COOKIE ‚îÄ‚îÄ
  {
    id:'insecure-cookie',lang:['python','javascript','php','general'],severity:'medium',
    title:'Insecure Cookie Configuration',
    owasp:'A02:2021 - Cryptographic Failures',
    pattern:/set_cookie\s*\((?!.*secure)|setCookie\s*\((?!.*secure)|setcookie\s*\((?!.*true)/i,
    description:'Cookies are being set without Secure and HttpOnly flags, making them vulnerable to interception over HTTP and theft via XSS attacks.',
    vulnExample:`response.set_cookie("session", token)`,
    fixExample:`response.set_cookie("session", token,\n    secure=True,\n    httponly=True,\n    samesite="Strict")`,
    fixSteps:[
      'Set the Secure flag to ensure cookies are only sent over HTTPS',
      'Set the HttpOnly flag to prevent JavaScript access to session cookies',
      'Set SameSite=Strict or Lapse to prevent CSRF attacks',
      'Set appropriate expiry times for session cookies'
    ]
  },

  // ‚îÄ‚îÄ PYTHON SPECIFIC ‚îÄ‚îÄ
  {
    id:'shell-true',lang:['python'],severity:'high',
    title:'Subprocess with shell=True',
    owasp:'A03:2021 - Injection',
    pattern:/subprocess\.\w+\s*\(.*shell\s*=\s*True/i,
    description:'Using shell=True with subprocess allows shell metacharacters in input to execute unintended commands. This is particularly dangerous when any part of the command includes user input.',
    vulnExample:`subprocess.call(f"ls {user_path}", shell=True)`,
    fixExample:`subprocess.call(["ls", user_path])  # shell=False (default)`,
    fixSteps:[
      'Remove shell=True and pass the command as a list of arguments instead',
      'Validate and sanitize any input that becomes part of a command',
      'If shell features are needed, use shlex.quote() to escape arguments',
      'Consider using Python library equivalents instead of shell commands'
    ]
  },
  {
    id:'assert-security',lang:['python'],severity:'low',
    title:'Security Check Using assert Statement',
    owasp:'A07:2021 - Identification and Authentication Failures',
    pattern:/assert\s+\w*(auth|permission|admin|role|login|access)/i,
    description:'Python assert statements are removed when code is run with the -O (optimize) flag. Using assert for security checks means those checks can be completely bypassed.',
    vulnExample:`assert user.is_admin, "Access denied"`,
    fixExample:`if not user.is_admin:\n    raise PermissionError("Access denied")`,
    fixSteps:[
      'Replace all security-related assert statements with proper if/raise logic',
      'Use explicit exception raising for access control checks',
      'Never rely on assert for any security enforcement'
    ]
  }
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCANNER ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function scanCode(code, lang) {
  const findings = [];
  const lines = code.split('\n');

  for (const rule of RULES) {
    if (!rule.lang.includes(lang) && !rule.lang.includes('general')) continue;
    if (rule.pattern.test(code)) {
      // Find the line number
      let lineNum = null;
      for (let i = 0; i < lines.length; i++) {
        if (rule.pattern.test(lines[i])) { lineNum = i + 1; break; }
      }
      findings.push({ ...rule, lineNum });
    }
  }

  // Sort by severity
  const order = { critical: 0, high: 1, medium: 2, low: 3, info: 4 };
  findings.sort((a, b) => order[a.severity] - order[b.severity]);

  return findings;
}

function calcScore(findings) {
  if (findings.length === 0) return 97;
  let deduct = 0;
  for (const f of findings) {
    if (f.severity === 'critical') deduct += 30;
    else if (f.severity === 'high') deduct += 20;
    else if (f.severity === 'medium') deduct += 10;
    else if (f.severity === 'low') deduct += 5;
  }
  return Math.max(0, 100 - deduct);
}

function getVerdict(score, findings) {
  if (findings.length === 0) return 'No Vulnerabilities Detected';
  const crits = findings.filter(f => f.severity === 'critical').length;
  if (crits > 0) return `${crits} Critical Issue${crits > 1 ? 's' : ''} Found ‚Äî Immediate Action Required`;
  if (score < 50) return 'High Risk ‚Äî Multiple Security Issues Detected';
  if (score < 80) return 'Moderate Risk ‚Äî Security Issues Need Attention';
  return 'Low Risk ‚Äî Minor Issues Found';
}

function getSummary(score, findings) {
  if (findings.length === 0) return 'This code passed all security checks in our static analysis engine. No common vulnerability patterns from OWASP Top 10 were detected. Continue following secure coding best practices.';
  const crits = findings.filter(f => f.severity === 'critical');
  const highs = findings.filter(f => f.severity === 'high');
  let s = `Found ${findings.length} security issue${findings.length > 1 ? 's' : ''} in this code. `;
  if (crits.length) s += `${crits.length} critical vulnerabilit${crits.length > 1 ? 'ies require' : 'y requires'} immediate remediation. `;
  if (highs.length) s += `${highs.length} high-severity issue${highs.length > 1 ? 's' : ''} should be addressed before deployment. `;
  s += 'Review each finding below for detailed fix instructions.';
  return s;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedLang = 'python';

function setLang(btn, lang) {
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  selectedLang = lang;
}

function updateLines() {
  const ta = document.getElementById('code');
  const lines = ta.value.split('\n');
  const ln = document.getElementById('lineNums');
  ln.innerHTML = lines.map((_,i) => `<div class="line-num">${i+1}</div>`).join('');
}

function updateCount() {
  const val = document.getElementById('code').value;
  document.getElementById('charCount').textContent =
    `${val.length} characters ¬∑ ${val.split('\n').length} lines`;
}

function showError(msg) {
  const eb = document.getElementById('errorBox');
  document.getElementById('errorMsg').textContent = msg;
  eb.classList.add('active');
}

function hideError() { document.getElementById('errorBox').classList.remove('active'); }

function reset() {
  document.getElementById('results').style.display = 'none';
  document.getElementById('results').classList.remove('active');
  document.getElementById('inputSection').style.display = 'block';
  document.getElementById('code').value = '';
  document.getElementById('analyzeBtn').disabled = false;
  updateLines(); updateCount(); hideError();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function analyze() {
  const code = document.getElementById('code').value.trim();
  if (!code) { showError('Please paste some code before scanning.'); return; }
  hideError();
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('scanning').classList.add('active');

  const steps = document.querySelectorAll('.scan-step');
  steps.forEach((s, i) => setTimeout(() => s.classList.add('visible'), i * 400));

  setTimeout(() => {
    const findings = scanCode(code, selectedLang);
    const score = calcScore(findings);
    steps.forEach(s => s.classList.remove('visible'));
    document.getElementById('scanning').classList.remove('active');
    renderResults(findings, score);
  }, 2400);
}

function renderResults(findings, score) {
  document.getElementById('inputSection').style.display = 'none';
  document.getElementById('results').classList.add('active');
  document.getElementById('results').style.display = 'block';

  const level = score >= 80 ? 'safe' : score >= 50 ? 'warn' : 'danger';
  const counts = { critical:0, high:0, medium:0, low:0 };
  findings.forEach(f => { if (counts[f.severity] !== undefined) counts[f.severity]++; });

  // Score Card
  document.getElementById('scoreCardWrap').innerHTML = `
    <div class="score-card">
      <div class="score-circle ${level}">
        <div class="score-num">${score}</div>
        <div class="score-lbl">/ 100</div>
      </div>
      <div class="score-info">
        <h3>${getVerdict(score, findings)}</h3>
        <p>${getSummary(score, findings)}</p>
        <div class="score-bar-wrap">
          <div class="score-bar-bg">
            <div class="score-bar-fill ${level}" style="width:${score}%"></div>
          </div>
        </div>
      </div>
      <div class="vuln-badges">
        ${counts.critical > 0 ? `<div class="vuln-badge critical">üî¥ ${counts.critical} Critical</div>` : ''}
        ${counts.high > 0 ? `<div class="vuln-badge high">üü† ${counts.high} High</div>` : ''}
        ${counts.medium > 0 ? `<div class="vuln-badge medium">üü° ${counts.medium} Medium</div>` : ''}
        ${counts.low > 0 ? `<div class="vuln-badge low">üü¢ ${counts.low} Low</div>` : ''}
        ${findings.length === 0 ? `<div class="vuln-badge info">‚úÖ All Clear</div>` : ''}
      </div>
    </div>`;

  // Issues
  const iw = document.getElementById('issuesWrap');
  if (findings.length === 0) {
    iw.innerHTML = `
      <div class="safe-banner">
        <div class="safe-icon">‚úÖ</div>
        <div>
          <h3>No Vulnerabilities Found</h3>
          <p>This code passed all ${RULES.length} security rules. No OWASP Top 10 vulnerability patterns were detected.</p>
        </div>
      </div>`;
  } else {
    iw.innerHTML = `<div class="section-title">Vulnerabilities Found (${findings.length})</div>` +
      findings.map((f, i) => `
        <div class="issue-card" id="iss${i}">
          <div class="issue-header" onclick="toggleIssue(${i})">
            <span class="sev-pill ${f.severity}">${f.severity}</span>
            <div class="issue-title-wrap">
              <div class="issue-title">${f.title}${f.lineNum ? ` <span style="color:var(--muted);font-size:12px;font-family:var(--mono)">¬∑ line ${f.lineNum}</span>` : ''}</div>
              <div class="issue-owasp">${f.owasp}</div>
            </div>
            <span class="issue-toggle">‚åÑ</span>
          </div>
          <div class="issue-body">
            <div class="issue-section">
              <div class="issue-section-label">üìã What's Wrong</div>
              <div class="issue-desc">${f.description}</div>
            </div>
            ${f.vulnExample ? `
            <div class="issue-section">
              <div class="issue-section-label">‚ö†Ô∏è Vulnerable Pattern</div>
              <div class="code-block vuln"><span class="cb-label">UNSAFE</span><pre>${esc(f.vulnExample)}</pre></div>
            </div>` : ''}
            ${f.fixExample ? `
            <div class="issue-section">
              <div class="issue-section-label">‚úÖ Secure Version</div>
              <div class="code-block fix"><span class="cb-label">SAFE</span><pre>${esc(f.fixExample)}</pre></div>
            </div>` : ''}
            <div class="issue-section">
              <div class="issue-section-label">üîß How to Fix</div>
              <ul class="fix-steps">
                ${f.fixSteps.map(s => `<li>${s}</li>`).join('')}
              </ul>
            </div>
          </div>
        </div>`).join('');
  }

  // Summary
  document.getElementById('summaryWrap').innerHTML = `
    <div class="summary-box">
      <h4>üìä Security Assessment Summary</h4>
      <p>Scanned against <strong style="color:var(--accent)">${RULES.length} vulnerability rules</strong> mapped to OWASP Top 10 2021. 
      Security score: <strong style="color:var(--accent)">${score}/100</strong>. 
      ${findings.length > 0 ? `Resolve all <strong style="color:var(--danger)">${findings.length} issue${findings.length > 1?'s':''}</strong> before deploying this code to production.` : 'This code appears safe based on static pattern analysis.'}
      </p>
    </div>`;

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function toggleIssue(i) {
  document.getElementById('iss' + i).classList.toggle('open');
}

function esc(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

updateLines(); updateCount();
</script>
</body>
</html>
